<!DOCTYPE html>
<html>
	<head>
		<script src="/socket.io/socket.io.js"></script>
		<script src="/jquery.js"></script>
		<script	src="/moment.js"></script>
		<script	src="/chart.js"></script>

		<title>Rodeløkka Børs</title>
	</head>
	<body>
		<canvas id="myChart" width="160" height="83" ></canvas>
		<div id="prices">
		</div>
	</body>
	<script>
		var socket = io();
		var items;
		var isPricesMade = false;

		socket.emit('reqDefaults');
		socket.on('defItems', function(val) {
			if(!isPricesMade) {
				isPricesMade = true;
				items = val;

				if(typeof chartData === "undefined") {
					makeChart();
				}
			}
		});

		var ctx = document.getElementById("myChart");

		function makeChart() {
			var curTime = moment().format("dd, DD.MM.YY, h:mm:ss");

			chartData = {
				labels: [curTime],
				datasets:[]
			};

			for(var i=0; i<items.length; i++) {
				chartData.datasets.push(items[i].dataset);
			}

			fillItemsData();

			chartOptions = {
				title: {
					display: true,
					text: 'Rodeløkka Børs',
					fontSize: 32,
					padding: 100
						
				},
				legend: {
					position: 'top',
					fullWidth: true,
					labels: {
						padding: 120,
						generateLabels: getNewLabels,
						fontSize: 28,
					}
				},
				showLines: false,
				scales: {
					xAxes: [{
						display: false,
					}],
					yAxes: [{
						display: false,
					}]
				},
				animation: {
					duration: 1000
				}
			};

			myChart = new Chart(ctx, {
				type: 'line',
				data: chartData,
				options: chartOptions
			});

		};

		function getNewLabels(chart) {
			var lab = Chart.defaults.global.legend.labels.generateLabels(chart);
			for(var i=0; i<lab.length;i++) {
				lab[i].text += ": " + items[i].price.toFixed(2).replace(/\./g, ",") + " NOK";
			}
			return lab;
		};

		function fillItemsData() {
			if(localStorage.getItem("labels") !== null) {
				console.log("Fetching old chartData");
				chartData.labels = JSON.parse(localStorage.getItem('labels'));

				for(var i=0; i<items.length; i++) {
					var name = 'item' + i;
					items[i].dataset.data = JSON.parse(localStorage.getItem(name));

					var len = items[i].dataset.data.length;
					items[i].price = items[i].dataset.data[len - 1];
				}
			} else {
				console.log("Making new data");
				for(var i=0; i<items.length; i++) {
					items[i].dataset.data = [items[i].price];
				}
			}
		};

		socket.on('updatePrices', function(newPrices) {
			var curTime = moment().format("dd, DD.MM.YY, h:mm:ss");

			chartData.labels.push(curTime);

			for(var i=0; i<items.length; i++) {
				items[i].price = newPrices[i];
				items[i].dataset.data.push(items[i].price);

			}
			myChart.update();
		});

	</script>
</html>
