<!DOCTYPE html>
<html>
	<script src="/socket.io/socket.io.js"></script>
	<script src="/jquery.js"></script>
	<script	src="/moment.js"></script>
	<script	src="/chart.js"></script>
	<head>
		<title>Rodeløkka Børs</title>
		<style>
			* { margin: 0; padding: 0; box-sizing: border-box; }
			body { font: 13px Helvetica, Arial; }
			form { background: #000; padding: 3px; position: fixed; bottom: 0; width: 100%; }
			form input { border: 0; padding: 10px; width: 90%; margin-right: .5%; }
			form button { width: 9%; background: rgb(130, 224, 255); border: none; padding: 10px; }
		</style>
	</head>
	<body>
		<canvas id="myChart" width="160" height="83" ></canvas>
	</body>
	<script> 
		var minØlPrice = 37;
		var minVinPrice = 40;
		var minVannPrice = 10;

		var ølPrice = minØlPrice * 1.5;
		var vinPrice = minVinPrice * 1.5;
		var vannPrice = minVannPrice * 1.5;

		if(localStorage.getItem("ølPrice") !== null) {
			ølPrice = Number(localStorage.ølPrice);
			vinPrice = Number(localStorage.vinPrice);
			vannPrice = Number(localStorage.vannPrice);
		}

		var incPerTick = 1;
		var decPerTick = incPerTick * 0.25;

		var ctx = document.getElementById("myChart");

		var curTime = moment().format("dd, DD.MM.YY, h:mm:ss");

		var chartData = {
				labels: [curTime],
				datasets: [{
					label: 'Øl',
					data:[ølPrice],
					backgroundColor: 'rgba(255, 207, 112, 0.1)',
					borderColor: 'rgba(255, 207, 112, 1)',
					borderWidth: 1,
					pointRadius: 0
				},
				{
					label: 'Vin',
					data:[vinPrice],
					backgroundColor: 'rgba(255, 112, 255, 0.1)',
					borderColor: 'rgba(255, 112, 255, 1)',
					borderWidth: 1,
					pointRadius: 0
				},
				{
					label: 'Vann',
					data:[vannPrice],
					backgroundColor: 'rgba(112, 112, 255, 0.1',
					borderColor: 'rgba(112, 112, 255, 1)',
					borderWidth: 1,
					pointRadius: 0
				}]
		};

		if(localStorage.getItem("labels") !== null) {
			console.log("Fetching old chartData");
			chartData.labels = JSON.parse(localStorage.getItem("labels"));
			chartData.datasets[0].data = JSON.parse(localStorage.getItem("ølData"));
			chartData.datasets[1].data = JSON.parse(localStorage.getItem("vinData"));
			chartData.datasets[2].data = JSON.parse(localStorage.getItem("vannData"));
		};

		var chartOptions = {
			title: {
				display: true,
				text: 'Rodeløkka Børs',
				fontSize: 32
			},
			legend: {
				position: 'right',
				labels: {
					padding: 100,
					generateLabels: getNewLabels,
					fontSize: 32,
				}
			},
			maintainAspectRatio: true,
			spanGaps: true,
			scales: {
				yAxes: [{
					ticks: {
						beginAtZero:true
					}
				}],
			},
			animation: {
				duration: 1000
			}

		};

		function getNewLabels(chart) {
			var lab = Chart.defaults.global.legend.labels.generateLabels(chart);
			lab[0].text += ": " + ølPrice.toFixed(2).replace(/\./g, ",") + " NOK";
			lab[1].text += ": " + vinPrice.toFixed(2).replace(/\./g, ",") + " NOK";
			lab[2].text += ": " + vannPrice.toFixed(2).replace(/\./g, ",") + " NOK";
			return lab;
		};

		var myChart = new Chart(ctx, {
			type: 'line',
			data: chartData,
			options: chartOptions
		});



		setInterval(function(){
			chartData.datasets[0].data.push(ølPrice);
			chartData.datasets[1].data.push(vinPrice);
			chartData.datasets[2].data.push(vannPrice);

			curTime = moment().format("dd, DD.MM.YY, h:mm:ss");
			chartData.labels.push(curTime);

			var latestLabel = chartData.labels[2];

			if(ølPrice > minØlPrice) {
				ølPrice -= decPerTick;
			}

			if(vinPrice > minVinPrice) {
				vinPrice -= decPerTick;
			}

			if(vannPrice > minVannPrice) {
				vannPrice -= decPerTick;
			}

			myChart.update();

			localStorage.ølPrice = ølPrice;
			localStorage.vinPrice = vinPrice;
			localStorage.vannPrice = vannPrice;
		}, 2000);

		setInterval(function() {
			console.log('Saving data');
			localStorage.setItem("labels", JSON.stringify(chartData.labels));
			localStorage.setItem("ølData", JSON.stringify(chartData.datasets[0].data));
			localStorage.setItem("vinData", JSON.stringify(chartData.datasets[1].data));
			localStorage.setItem("vannData", JSON.stringify(chartData.datasets[2].data));
		}, 10000);

		///////////
		//Sockets//
		///////////

		// Bar
		var socket = io();
		socket.on('ølPress', function(msg){
			ølPrice += incPerTick;
		});


		socket.on('vinPress', function(msg){
			vinPrice += incPerTick;
		});

		socket.on('vannPress', function(msg){
			vannPrice += incPerTick;
		});

		// Regulering
		socket.on('incPerTickDec', function(msg){
			console.log('Decreasing inc per tick');
			incPerTick *= 0.90;
			console.log(incPerTick);
		});

		socket.on('incPerTickInc', function(msg){
			console.log('Increasing inc per tick');
			incPerTick *= 1.10;
			console.log(incPerTick);
		});
		
	</script>
</html>
