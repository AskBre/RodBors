<!DOCTYPE html>
<html>
	<script src="/socket.io/socket.io.js"></script>
	<script src="/jquery.js"></script>
	<script	src="/moment.js"></script>
	<script	src="/chart.js"></script>
	<head>
		<title>Rodeløkka Børs</title>
		<style>
			* { margin: 0; padding: 0; box-sizing: border-box; }
			body { font: 13px Helvetica, Arial; }
			form { background: #000; padding: 3px; position: fixed; bottom: 0; width: 100%; }
			form input { border: 0; padding: 10px; width: 90%; margin-right: .5%; }
			form button { width: 9%; background: rgb(130, 224, 255); border: none; padding: 10px; }
		</style>
	</head>
	<body>
		<canvas id="myChart" width="160" height="83" ></canvas>
	</body>
	<script> 

		var socket = io();
		var items;
	

		var isDefDefined = false;
		var incPerClick = 0;
		var decPerTick = 0;

		// Get defaults from index.js 
		socket.emit('reqDefaults');
		socket.on('defIncPerClick', function(val) {
			if(!isDefDefined) {
				incPerClick = val;
			}
		});

		socket.on('defDecPerTick', function(val) {
			if(!isDefDefined) {
				decPerTick = val;
			}
		});

		socket.on('defItems', function(val) {
			if(!isDefDefined) {
				items = val;
				isDefDefined = true;

				if(typeof chartData === "undefined") {
//					deleteLocalStorage();
					makeChart();
				}
			}
		});

		var ctx = document.getElementById("myChart");

		function makeChart() {
			var curTime = moment().format("dd, DD.MM.YY, h:mm:ss");

			chartData = {
				labels: [curTime],
				datasets:[]
			};

			for(var i=0; i<items.length; i++) {
				chartData.datasets.push(items[i].dataset);
			}

			fillItemsData();

			chartOptions = {
				title: {
					display: true,
					text: 'Rodeløkka Børs',
					fontSize: 32
				},
				legend: {
					position: 'right',
					labels: {
						padding: 25,
						generateLabels: getNewLabels,
						fontSize: 28,
					}
				},
				maintainAspectRatio: true,
				spanGaps: true,
				scales: {
					xAxes: [{
						ticks: {
							beginAtZero:true
						}
					}]

				},
				animation: {
					duration: 1000
				}
			};

			myChart = new Chart(ctx, {
				type: 'line',
				data: chartData,
				options: chartOptions
			});

		};


		
		
		
		function getNewLabels(chart) {
			var lab = Chart.defaults.global.legend.labels.generateLabels(chart);
			for(var i=0; i<lab.length;i++) {
				lab[i].text += ": " + items[i].price.toFixed(2).replace(/\./g, ",") + " NOK";
			}
			return lab;
		};

		

		setInterval(function(){
			var curTime = moment().format("dd, DD.MM.YY, h:mm:ss");

			chartData.labels.push(curTime);

			for(var i=0; i<items.length; i++) {
				items[i].dataset.data.push(items[i].price);

				if(items[i].price > items[i].minPrice) {
					items[i].price -= decPerTick;
				}
			}
			myChart.update();
		}, 2000);

		setInterval(function() {
			console.log('Saving data');
			localStorage.setItem("labels", JSON.stringify(chartData.labels));
			for(var i=0; i<items.length; i++) {
				var name = 'item' + i;
				localStorage.setItem(name, JSON.stringify(items[i].dataset.data));
			}
		}, 10000);

		function fillItemsData() {
			if(localStorage.getItem("labels") !== null) {
				console.log("Fetching old chartData");
				chartData.labels = JSON.parse(localStorage.getItem('labels'));

				for(var i=0; i<items.length; i++) {
					var name = 'item' + i;
					items[i].dataset.data = JSON.parse(localStorage.getItem(name));

					var len = items[i].dataset.data.length;
					items[i].price = items[i].dataset.data[len - 1];
				}
			} else {
				console.log("Making new data");
				for(var i=0; i<items.length; i++) {
					items[i].dataset.data = [items[i].price];
				}
			}
		};

		function deleteLocalStorage() {
			console.log("DELETING ALL LOCAL STORAGE!");
			localStorage.removeItem('labels');
			for(var i=0; i<items.length; i++) {
				var name = 'item' + i;
				localStorage.removeItem(name);
			}
		};

		///////////
		//Sockets//
		///////////

		// Bar
		// Send which button as message, not socket
		socket.on('Purchase', function(msg) {
			console.log('Received ' + msg);
			for(var i=0; i<items.length; i++) {
				if(items[i].dataset.label == msg) {
					items[i].price += incPerClick;
				}
			}
		});

		// Regulering
		socket.on('setIncPerClick', function(msg){
			incPerClick = msg;
			console.log(incPerClick);
		});

		socket.on('setDecPerTick', function(msg){
			decPerTick = msg;
		});

	</script>
</html>
